# å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ¯ é—®é¢˜æ€»ç»“

ä½ é‡åˆ°äº†**ä¸¤ä¸ªé—®é¢˜**ï¼š

### 1. âŒ Checkpoint åŠ è½½å¡ä½
**åŸå› **ï¼š`Algorithm.from_checkpoint()` é»˜è®¤åˆ›å»ºå¤šä¸ª workers  
**è§£å†³**ï¼šä½¿ç”¨ `num_env_runners=0` çš„è½»é‡çº§é…ç½®

### 2. âŒ å¾ªç¯å¯¼å…¥é”™è¯¯
**åŸå› **ï¼šæ¨ç†è„šæœ¬åå­— `qln_multi_flight_game_v2_inference.py` ä¸ç¯å¢ƒæ–‡ä»¶ `qln_multi_flight_game_v2.py` å¤ªç›¸ä¼¼  
**è§£å†³**ï¼šä½¿ç”¨æ–°æ–‡ä»¶å `flight_inference.py`

---

## âš¡ ç«‹å³è§£å†³ï¼ˆ3æ­¥æå®šï¼‰

### æ­¥éª¤1ï¼šå¤åˆ¶æ–°æ–‡ä»¶åˆ°ä½ çš„å·¥ä½œç›®å½•

```bash
# ä» /workspace å¤åˆ¶åˆ°ä½ çš„å·¥ä½œç›®å½•
cp /workspace/flight_inference.py /Users/lifeng/Documents/ai_code/rms_pytorch/nh_rms_pytorch/
```

### æ­¥éª¤2ï¼šæ¸…ç†ç¯å¢ƒ

```bash
# åœæ­¢æ—§çš„ Ray è¿›ç¨‹
ray stop

# æ¸…ç† Python ç¼“å­˜
cd /Users/lifeng/Documents/ai_code/rms_pytorch/nh_rms_pytorch/
find . -name "*.pyc" -delete
find . -name "__pycache__" -type d -exec rm -rf {} +
```

### æ­¥éª¤3ï¼šè¿è¡Œ

```bash
cd /Users/lifeng/Documents/ai_code/rms_pytorch/nh_rms_pytorch/

# åŸºæœ¬è¿è¡Œï¼ˆ10ä¸ªå›åˆï¼‰
python flight_inference.py

# è‡ªå®šä¹‰å‚æ•°ï¼ˆä½ çš„ä¾‹å­ï¼‰
python flight_inference.py --flight1_days 4 --flight2_capacity 90

# å®Œæ•´å‚æ•°ç¤ºä¾‹
python flight_inference.py \
    --episodes 5 \
    --flight1_days 25 \
    --flight1_capacity 150 \
    --flight2_days 28 \
    --flight2_capacity 200
```

---

## ğŸ“ æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | ç”¨é€” | æ¨èåº¦ |
|-----|------|--------|
| **`flight_inference.py`** | â­ **ä¸»æ¨ç†è„šæœ¬ï¼ˆä½¿ç”¨è¿™ä¸ªï¼ï¼‰** | â­â­â­â­â­ |
| `CIRCULAR_IMPORT_FIX.md` | å¾ªç¯å¯¼å…¥é—®é¢˜è¯¦ç»†è¯´æ˜ | ğŸ“– å‚è€ƒ |
| `STUCK_TROUBLESHOOTING.md` | å¡ä½é—®é¢˜è¯¦ç»†æ’æŸ¥ | ğŸ“– å‚è€ƒ |
| `setup_and_run.sh` | ä¸€é”®è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆå¯é€‰ï¼‰ | ğŸ”§ è¾…åŠ© |

---

## ğŸ”§ å¯é€‰ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬

å¦‚æœä½ æƒ³ä¸€é”®å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼Œä½¿ç”¨æä¾›çš„ shell è„šæœ¬ï¼š

### Mac/Linux:

```bash
# 1. ä¿®æ”¹è„šæœ¬ä¸­çš„è·¯å¾„ï¼ˆå¦‚æœéœ€è¦ï¼‰
nano setup_and_run.sh

# 2. æ·»åŠ æ‰§è¡Œæƒé™
chmod +x setup_and_run.sh

# 3. è¿è¡Œ
./setup_and_run.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… æ£€æŸ¥æ–‡ä»¶å’Œç›®å½•
- âœ… å¤åˆ¶æ¨ç†è„šæœ¬
- âœ… æ¸…ç†æ—§è¿›ç¨‹å’Œç¼“å­˜
- âœ… è¿è¡Œæ¨ç†

---

## ğŸ“Š é¢„æœŸè¾“å‡º

æˆåŠŸè¿è¡Œåï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
================================================================================
          å¤šèˆªç­åŠ¨æ€å®šä»·æ¨ç† - ä¿®å¤ç‰ˆæœ¬
================================================================================

[1/5] éªŒè¯æ–‡ä»¶...
âœ“ Checkpoint æ–‡ä»¶å­˜åœ¨
âœ“ å‡†å¤‡å¯¼å…¥ç¯å¢ƒ...

[2/5] åˆå§‹åŒ– Ray...
âœ“ Ray 2.9.0 åˆå§‹åŒ–æˆåŠŸ

[3/5] å¯¼å…¥å’Œæ³¨å†Œç¯å¢ƒ...
âœ“ ç¯å¢ƒæ¨¡å—å¯¼å…¥æˆåŠŸ
âœ“ ç¯å¢ƒ 'multi_flight_v0' æ³¨å†ŒæˆåŠŸ

[4/5] åŠ è½½æ¨¡å‹...
æç¤º: è¿™ä¸€æ­¥å¯èƒ½éœ€è¦30-90ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…...

[æ–¹æ³•1] ä½¿ç”¨è½»é‡çº§é…ç½®åŠ è½½...
  â†’ åˆ›å»º Algorithm å¯¹è±¡...
  â†’ ä» checkpoint æ¢å¤æƒé‡...
  â†’ è·å– policy...
âœ“ æ–¹æ³•1åŠ è½½æˆåŠŸï¼

[5/5] è®¾ç½®æ¨ç†...
âœ“ æ¨ç†æµ‹è¯•æˆåŠŸï¼ç¤ºä¾‹åŠ¨ä½œ: 2, 2

================================================================================
å¼€å§‹æ¨ç†æµ‹è¯•
================================================================================

è¿è¡Œ 10 ä¸ªå®Œæ•´å›åˆ...
  ç¬¬  1 å›åˆ â†’ æ€»æ”¶ç›Š XXX,XXX | èˆªç­1 XXX,XXX (XX.X%) | èˆªç­2 XXX,XXX (XX.X%)
  ç¬¬  2 å›åˆ â†’ æ€»æ”¶ç›Š XXX,XXX | èˆªç­1 XXX,XXX (XX.X%) | èˆªç­2 XXX,XXX (XX.X%)
  ...
  ç¬¬ 10 å›åˆ â†’ æ€»æ”¶ç›Š XXX,XXX | èˆªç­1 XXX,XXX (XX.X%) | èˆªç­2 XXX,XXX (XX.X%)

================================================================================
ç»Ÿè®¡æ€»ç»“
================================================================================
å¹³å‡æ€»æ”¶ç›Š: XXX,XXX Â± X,XXX
æœ€é«˜æ€»æ”¶ç›Š: XXX,XXX
æœ€ä½æ€»æ”¶ç›Š: XXX,XXX
èˆªç­1 - å¹³å‡æ”¶ç›Š: XXX,XXX  å¹³å‡è´Ÿè½½: XX.X%
èˆªç­2 - å¹³å‡æ”¶ç›Š: XXX,XXX  å¹³å‡è´Ÿè½½: XX.X%

================================================================================
æœ€ä¼˜å›åˆè¯¦ç»†å†³ç­–è¿‡ç¨‹
================================================================================
æ­£åœ¨æœç´¢ 20 ä¸ªå›åˆä¸­çš„æœ€ä¼˜ç­–ç•¥...

æœ€ä½³æ€»æ”¶ç›Š: XXX,XXX

å¤©æ•°  èˆªç­1ä»·æ ¼  èˆªç­2ä»·æ ¼  èˆªç­1å”®ç¥¨  èˆªç­2å”®ç¥¨  èˆªç­1è´Ÿè½½   èˆªç­2è´Ÿè½½   å½“å¤©æ”¶ç›Š1   å½“å¤©æ”¶ç›Š2   å½“å¤©æ€»æ”¶ç›Š
----  ---------  ---------  ---------  ---------  ----------  ----------  ----------  ----------  ----------
  1      1200       1200          5          6      2.54%      2.61%        6000        7200       13200
  2      1150       1150          6          7      5.58%      5.65%       13200       15350       28550
  ...
 30       800        800         10         12     100.00%    100.00%       80000       96000      176000

================================================================================
âœ“ æ¨ç†å®Œæˆï¼
================================================================================
```

**æ•´ä¸ªè¿‡ç¨‹ 1-2 åˆ†é’Ÿå®Œæˆï¼**

---

## ğŸ” å¦‚æœè¿˜æœ‰é—®é¢˜

### é—®é¢˜1ï¼šè¿˜æ˜¯æŠ¥å¾ªç¯å¯¼å…¥é”™è¯¯

```bash
# ç¡®è®¤æ–‡ä»¶å
ls -lh | grep -E "flight_inference|qln_multi_flight_game_v2"

# ä½ åº”è¯¥çœ‹åˆ°ï¼š
# flight_inference.py           â† æ¨ç†è„šæœ¬
# qln_multi_flight_game_v2.py   â† ç¯å¢ƒæ–‡ä»¶

# å¦‚æœçœ‹åˆ°æ—§çš„æ¨ç†è„šæœ¬ï¼Œåˆ é™¤å®ƒä»¬
rm -f qln_multi_flight_game_v2_inference*.py
```

### é—®é¢˜2ï¼šè¿˜æ˜¯åŠ è½½å¡ä½

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æ—§çš„ Ray è¿›ç¨‹
ps aux | grep ray

# å¼ºåˆ¶åœæ­¢
pkill -9 ray

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf /tmp/ray

# é‡æ–°è¿è¡Œ
python flight_inference.py
```

### é—®é¢˜3ï¼šæ‰¾ä¸åˆ° MultiFlightGymEnv

```bash
# æµ‹è¯•ç¯å¢ƒæ–‡ä»¶æ˜¯å¦æ­£å¸¸
python -c "from qln_multi_flight_game_v2 import MultiFlightGymEnv; print('âœ“ å¯¼å…¥æˆåŠŸ')"

# å¦‚æœå¤±è´¥ï¼Œæ£€æŸ¥ç¯å¢ƒæ–‡ä»¶
python -m py_compile qln_multi_flight_game_v2.py
```

### é—®é¢˜4ï¼šCheckpoint è·¯å¾„é”™è¯¯

```bash
# æ£€æŸ¥ checkpoint æ˜¯å¦å­˜åœ¨
ls -lh /Users/lifeng/ray_results/FlightPPO_Final_2025/PPO_multi_flight_v0_f4f6f_00000_0_2025-11-18_16-31-19/checkpoint_000000

# åˆ—å‡º checkpoint å†…å®¹
ls -lh /Users/lifeng/ray_results/FlightPPO_Final_2025/PPO_multi_flight_v0_f4f6f_00000_0_2025-11-18_16-31-19/checkpoint_000000/

# åº”è¯¥çœ‹åˆ°ï¼š
# algorithm_state.pkl
# policies/
# rllib_checkpoint.json
```

å¦‚æœè·¯å¾„ä¸å¯¹ï¼Œç¼–è¾‘ `flight_inference.py` ä¿®æ”¹ç¬¬ 20 è¡Œçš„ `checkpoint_path`ã€‚

---

## ğŸ“ å‘½ä»¤è¡Œå‚æ•°è¯´æ˜

```bash
python flight_inference.py [é€‰é¡¹]

é€‰é¡¹:
  --episodes N              æµ‹è¯•å›åˆæ•°ï¼ˆé»˜è®¤: 10ï¼‰
  --flight1_days N          èˆªç­1å‰©ä½™å¤©æ•°ï¼ˆé»˜è®¤: 30ï¼‰
  --flight1_capacity N      èˆªç­1å‰©ä½™åº§ä½æ•°ï¼ˆé»˜è®¤: 197ï¼‰
  --flight2_days N          èˆªç­2å‰©ä½™å¤©æ•°ï¼ˆé»˜è®¤: 30ï¼‰
  --flight2_capacity N      èˆªç­2å‰©ä½™åº§ä½æ•°ï¼ˆé»˜è®¤: 230ï¼‰
```

**ç¤ºä¾‹**ï¼š

```bash
# è¿è¡Œ 5 ä¸ªå›åˆ
python flight_inference.py --episodes 5

# æµ‹è¯•èˆªç­1åªå‰©4å¤©ï¼Œ90ä¸ªåº§ä½çš„æƒ…å†µ
python flight_inference.py --flight1_days 4 --flight1_capacity 90

# æµ‹è¯•ä¸¤ä¸ªèˆªç­ä¸åŒçŠ¶æ€
python flight_inference.py \
    --flight1_days 10 \
    --flight1_capacity 100 \
    --flight2_days 15 \
    --flight2_capacity 120

# å¿«é€Ÿæµ‹è¯•ï¼ˆ1ä¸ªå›åˆï¼‰
python flight_inference.py --episodes 1
```

---

## ğŸ“ˆ æ€§èƒ½æç¤º

### åŠ è½½é€Ÿåº¦
- **ç¬¬ä¸€æ¬¡åŠ è½½**ï¼š60-90ç§’ï¼ˆéœ€è¦åˆå§‹åŒ– Ray å’ŒåŠ è½½æƒé‡ï¼‰
- **åç»­è¿è¡Œ**ï¼š30-60ç§’ï¼ˆRay å·²åˆå§‹åŒ–ï¼‰

### æ¨ç†é€Ÿåº¦
- **æ¯å›åˆ**ï¼š2-5ç§’ï¼ˆå–å†³äºå›åˆé•¿åº¦ï¼‰
- **10ä¸ªå›åˆ**ï¼šçº¦ 20-50ç§’

### æ€»è€—æ—¶
- **å®Œæ•´è¿è¡Œï¼ˆ10ä¸ªå›åˆ + æœ€ä¼˜æœç´¢20ä¸ªå›åˆï¼‰**ï¼šçº¦ 2-3 åˆ†é’Ÿ

---

## âœ… æˆåŠŸæ ‡å¿—

å¦‚æœä½ çœ‹åˆ°äº†ä»¥ä¸‹ä¿¡æ¯ï¼Œè¯´æ˜**ä¸€åˆ‡æ­£å¸¸**ï¼š

- âœ“ Checkpoint æ–‡ä»¶å­˜åœ¨
- âœ“ ç¯å¢ƒæ¨¡å—å¯¼å…¥æˆåŠŸ
- âœ“ ç¯å¢ƒ 'multi_flight_v0' æ³¨å†ŒæˆåŠŸ
- âœ“ æ–¹æ³•1åŠ è½½æˆåŠŸï¼
- âœ“ æ¨ç†æµ‹è¯•æˆåŠŸï¼

ç„¶åå¼€å§‹è¾“å‡ºæ¨ç†ç»“æœï¼Œè¯´æ˜**å®Œå…¨ä¿®å¤æˆåŠŸ**ï¼

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½ä¸èƒ½è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. **å®Œæ•´çš„é”™è¯¯ä¿¡æ¯**
```bash
python flight_inference.py 2>&1 | tee error.log
```

2. **ç¯å¢ƒä¿¡æ¯**
```bash
python --version
pip show ray
pip list | grep -E "ray|gymnasium|gym"
```

3. **æ–‡ä»¶ç»“æ„**
```bash
ls -lh /Users/lifeng/Documents/ai_code/rms_pytorch/nh_rms_pytorch/
```

4. **Checkpoint ä¿¡æ¯**
```bash
ls -R /Users/lifeng/ray_results/FlightPPO_Final_2025/PPO_multi_flight_v0_f4f6f_00000_0_2025-11-18_16-31-19/checkpoint_000000/
```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **æ–‡ä»¶é‡å‘½å** - `flight_inference.py` é¿å…å¾ªç¯å¯¼å…¥
2. **è½»é‡çº§åŠ è½½** - `num_env_runners=0` é¿å…å¡ä½
3. **è¯¦ç»†è¿›åº¦** - åˆ†æ­¥æ˜¾ç¤ºï¼ŒçŸ¥é“æ‰§è¡Œåˆ°å“ªé‡Œ
4. **é”™è¯¯å¤„ç†** - å¤šç§åŠ è½½æ–¹æ³•è‡ªåŠ¨å°è¯•

### ä½¿ç”¨æµç¨‹

```bash
# ä¸€è¡Œå‘½ä»¤æå®š
ray stop && cd /Users/lifeng/Documents/ai_code/rms_pytorch/nh_rms_pytorch/ && python flight_inference.py
```

### é¢„æœŸç»“æœ

- âš¡ 1-2 åˆ†é’Ÿå®Œæˆæ•´ä¸ªæ¨ç†
- ğŸ“Š è¾“å‡ºè¯¦ç»†çš„æ”¶ç›Šå’Œè´Ÿè½½æ•°æ®
- ğŸ¯ æ˜¾ç¤ºæœ€ä¼˜å›åˆçš„è¯¦ç»†å†³ç­–è¿‡ç¨‹
- âœ… æ”¯æŒè‡ªå®šä¹‰èµ·å§‹çŠ¶æ€æ¨¡æ‹Ÿ

**ç°åœ¨å°±å¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼** ğŸš€
